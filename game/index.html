<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>üçé H·ª©ng Qu·∫£ ‚Äî Bright Casual (Clean)</title>
  <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --base-w: 950px;
      --base-h: 600px;
      --scale: 1;
      --bg: #fcf8e3;
      --panel: #7cb342;
      --accent: #ff9800
    }

    /* C·∫•u h√¨nh chung */
    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Fredoka, Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial
    }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      overflow: hidden
    }

    /* container that will be scaled */
    #game-wrap {
      width: var(--base-w);
      height: var(--base-h);
      transform: scale(var(--scale));
      transform-origin: center center;
      position: relative;
      transition: transform .18s ease
    }

    #game-container {
      width: 100%;
      height: 100%;
      border-radius: 18px;
      border: 10px solid var(--panel);
      overflow: hidden;
      background: linear-gradient(#87CEEB, #E0F7FA);
      position: relative
    }

    /* rotate overlay */
    #rotate-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.85);
      color: #fff;
      z-index: 120;
      flex-direction: column;
      text-align: center;
      padding: 20px;
      pointer-events: none;
    }

    #rotate-overlay.show {
      display: flex;
      pointer-events: auto;
    }

    .rotate-emoji {
      font-size: 3.5rem;
      margin-bottom: 10px;
      animation: rotate 1.8s ease-in-out infinite
    }

    @keyframes rotate {
      0% {
        transform: rotate(0)
      }

      50% {
        transform: rotate(90deg) scale(1.05)
      }

      100% {
        transform: rotate(0)
      }
    }

    /* Landscape Lock: Ch·ªâ hi·ªÉn th·ªã overlay khi ·ªü ch·∫ø ƒë·ªô d·ªçc (portrait) tr√™n m√†n h√¨nh nh·ªè */
    @media (max-width: 950px) and (orientation: portrait) {
      #rotate-overlay {
        display: flex;
      }

      #game-wrap {
        opacity: 0;
        pointer-events: none;
      }
    }

    /* bright casual UI */
    #top-ui {
      position: absolute;
      left: 12px;
      right: 12px;
      top: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      pointer-events: none;
      z-index: 60
    }

    .score-card {
      background: rgba(255, 255, 255, 0.98);
      padding: 10px 14px;
      border-radius: 22px;
      border: 4px solid var(--accent);
      font-weight: 800;
      display: flex;
      gap: 14px;
      align-items: center;
      pointer-events: auto
    }

    .score-small {
      font-size: 13px;
      color: #f44336
    }

    #controls-left {
      display: flex;
      gap: 10px;
      align-items: center
    }

    #controls-right {
      pointer-events: auto
    }

    /* basket */
    #basket {
      position: absolute;
      bottom: 12px;
      left: calc(50% - 55px);
      width: 110px;
      height: 110px;
      z-index: 70;
      pointer-events: none
    }

    #basket-img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      transition: transform .12s
    }

    /* X√ìA: .happy, .bomb-hit c≈© */

    /* --- HI·ªÜU ·ª®NG PH√ÅT S√ÅNG V√Ä RUNG M√ÄN H√åNH M·ªöI --- */

    /* 1. L·∫Øc nh·∫π gi·ªè khi h·ª©ng qu·∫£ */
    @keyframes bounce-basket {

      0%,
      100% {
        transform: scale(1) translateY(0);
      }

      50% {
        transform: scale(1.1) translateY(-8px);
      }
    }

    .basket-bounce {
      animation: bounce-basket 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    /* 2. Ph√°t s√°ng (Glow) khi h·∫°nh ph√∫c */
    .basket-glow {
      filter: drop-shadow(0 0 8px #ffeb3b) drop-shadow(0 0 15px #ff9800);
    }

    /* 3. L·∫Øc l∆∞ tr·∫°ng th√°i b√¨nh th∆∞·ªùng */
    @keyframes normal-float {

      0%,
      100% {
        transform: translateY(0px);
      }

      50% {
        transform: translateY(-3px);
      }
    }

    .basket-normal-float {
      animation: normal-float 2s ease-in-out infinite;
    }

    /* 4. Rung m√†n h√¨nh khi va ch·∫°m m·∫°nh */
    @keyframes screen-shake {
      0% {
        transform: translate(1px, 1px) scale(var(--scale));
      }

      10% {
        transform: translate(-1px, -2px) scale(var(--scale));
      }

      20% {
        transform: translate(-3px, 0px) scale(var(--scale));
      }

      30% {
        transform: translate(3px, 2px) scale(var(--scale));
      }

      40% {
        transform: translate(1px, -1px) scale(var(--scale));
      }

      50% {
        transform: translate(-1px, 2px) scale(var(--scale));
      }

      60% {
        transform: translate(-3px, 1px) scale(var(--scale));
      }

      70% {
        transform: translate(1px, -2px) scale(var(--scale));
      }

      80% {
        transform: translate(1px, 2px) scale(var(--scale));
      }

      90% {
        transform: translate(-1px, 1px) scale(var(--scale));
      }

      100% {
        transform: translate(0, 0) scale(var(--scale));
      }
    }

    .game-shake {
      animation: screen-shake 0.8s ease-in-out;
    }

    /* Player b·ªã va ch·∫°m (v·∫´n d√πng bomb-hit class c≈©) */
    .bomb-hit {
      transform: scale(0.86) rotate(-10deg);
    }


    /* items */
    .item {
      position: absolute;
      width: 56px;
      height: 56px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.6);
      backdrop-filter: blur(2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, .18);
      will-change: transform, top
    }

    .tainted {
      box-shadow: 0 0 12px 3px rgba(255, 80, 80, 0.18);
    }

    .bomb-mark {
      position: absolute;
      right: 2px;
      top: 2px;
      font-size: 12px
    }

    /* sparkle effect */
    .sparkle {
      position: absolute;
      pointer-events: none;
      z-index: 200;
      opacity: 0;
      transform: scale(.8);
    }

    .sparkle.show {
      animation: sparkle .45s ease-out forwards
    }

    @keyframes sparkle {
      0% {
        opacity: 0;
        transform: scale(.6)
      }

      40% {
        opacity: 1;
        transform: scale(1.05)
      }

      100% {
        opacity: 0;
        transform: scale(1.3)
      }
    }

    /* explosion */
    .boom {
      position: absolute;
      width: 160px;
      height: 160px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, rgba(255, 230, 120, 1), rgba(255, 120, 80, .9) 40%, rgba(255, 40, 40, .7) 60%, rgba(0, 0, 0, 0) 61%);
      filter: blur(6px);
      pointer-events: none;
      opacity: .95;
      transform: scale(.6);
      animation: boom 0.6s ease-out forwards;
      z-index: 220
    }

    @keyframes boom {
      0% {
        transform: scale(.6);
        opacity: 1
      }

      100% {
        transform: scale(1.4);
        opacity: 0
      }
    }

    /* overlays */
    .overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 240;
      flex-direction: column;
      background: rgba(0, 0, 0, 0.45);
      color: #fff
    }

    .hidden {
      display: none
    }

    /* --- CSS CHO PAUSE SCREEN (M·ªöI) --- */
    .pause-btn {
      padding: 10px 20px;
      border-radius: 20px;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 5px 0px 0px rgba(0, 0, 0, 0.2);
      transition: transform 0.1s, box-shadow 0.1s;
      border: 3px solid #fff;
      min-width: 130px;
    }

    .pause-btn:active {
      transform: translateY(3px);
      box-shadow: 0 2px 0px 0px rgba(0, 0, 0, 0.2);
    }

    .btn-green-cute {
      background: linear-gradient(to bottom, #aed581, #7cb342);
      color: white;
    }

    .btn-orange-cute {
      background: linear-gradient(to bottom, #ffb74d, #ff9800);
      color: white;
    }

    .music-slider-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #e0e0e0;
      padding: 8px 12px;
      border-radius: 12px;
      margin-top: 5px;
    }

    .music-toggle-btn {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #f44336;
      color: white;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
    }

    /* mobile controls */
    #control-buttons {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 12px;
      display: flex;
      gap: 22px;
      z-index: 90;
      pointer-events: none;
      display: none;
      /* M·∫∂C ƒê·ªäNH ·∫®N tr√™n Desktop */
    }

    .control-btn {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 30px;
      background: #4dd0e1;
      border: 6px solid #fff;
      pointer-events: auto;
      box-shadow: 0 10px 0 #00bcd4
    }

    .control-btn:active {
      transform: translateY(8px);
      box-shadow: 0 2px 0 #00bcd4
    }

    /* T·ªëi ∆∞u UI cho m√†n h√¨nh nh·ªè */
    @media (max-width:940px) {
      :root {
        --scale: 1
      }

      /* HI·ªÇN TH·ªä N√öT ·∫¢O TR√äN MOBILE */
      #control-buttons {
        display: flex
      }

      #top-ui {
        top: 8px;
        padding: 0 8px
      }

      .score-card {
        transform: scale(.95);
        padding: 8px 10px
      }

      #basket {
        width: 90px;
        height: 90px
      }

      .item {
        width: 48px;
        height: 48px;
        font-size: 30px
      }
    }
  </style>
</head>

<body>
  <div id="rotate-overlay">
    <div class="rotate-emoji">üîÑ</div>
    <div>Vui l√≤ng xoay ngang (Landscape) ƒë·ªÉ ch∆°i.</div>
  </div>

  <div id="game-wrap">
    <div id="game-container">

      <div id="start-screen" class="overlay">
        <div class="panel" style="text-align:center">
          <h1 style="font-size:44px;color:#ffeb3b;margin:6px 0">H·ª®NG QU·∫¢</h1>
          <div style="font-weight:700;margin:6px 0">ƒêi·ªÉm cao nh·∫•t: <span id="start-high">0</span></div>
          <div style="margin-top:10px;display:flex;gap:10px;justify-content:center">
            <button id="btn-start" class="btn"
              style="padding:10px 18px;border-radius:999px;background:linear-gradient(#ffeb3b,#ff9800);font-weight:800;cursor:pointer">CH∆†I
              NGAY ‚ñ∂</button>
            <button id="btn-instructions" class="btn"
              style="padding:10px 18px;border-radius:999px;background:#fff;font-weight:800;cursor:pointer">H∆Ø·ªöNG
              D·∫™N</button>
          </div>
        </div>
      </div>

      <div id="pause-screen" class="overlay hidden">
        <div class="panel" style="text-align:center; padding: 25px 30px;">
          <h2 style="font-size:36px; margin:0 0 10px 0; color:#333; text-shadow: 1px 1px 0 #fff;">T·∫†M D·ª™NG ‚è∏</h2>
          <div class="row" style="margin-bottom:20px; font-size:18px; color:#555; justify-content:center;">ƒêi·ªÉm: <strong
              id="pause-score" style="margin-left:8px; color:var(--accent)">0</strong></div>

          <div class="row" style="margin-bottom:25px; justify-content:center; gap:20px;">
            <button id="btn-resume" class="pause-btn btn-green-cute">TI·∫æP T·ª§C</button>
            <button id="btn-restart-2" class="pause-btn btn-orange-cute">CH∆†I L·∫†I</button>
          </div>

          <div style="background:#f0f0f0; padding:15px; border-radius:15px;">

            <div style="margin-bottom:15px;">
              <div style="font-weight:700; margin-bottom:4px; color:#555;">√Çm nh·∫°c & √Çm l∆∞·ª£ng</div>
              <div class="music-slider-wrap">
                <button id="music-toggle" class="music-toggle-btn">üîä</button>
                <input id="vol-slider" type="range" min="0" max="1" step="0.05" value="0.5" style="width:160px">
              </div>
            </div>

            <div>
              <div style="font-weight:700; margin-bottom:8px; color:#555;">Thay ƒë·ªïi ƒê·ªô kh√≥</div>
              <div class="row" style="justify-content:center; align-items:center;">
                <div style="font-weight:800; margin-right:10px; color:#333;">C·∫•p ƒë·ªô: <span id="diff-label"
                    style="font-weight:900; color:#2e7d32">D·ªÖ</span></div>
                <button id="btn-diff" class="pause-btn"
                  style="padding:6px 15px; border-radius:15px; background:#e0e0e0; color:#333; border: 2px solid #ccc; box-shadow: none;">TƒÉng/Gi·∫£m</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="game-over" class="overlay hidden">
        <div class="panel" style="text-align:center">
          <h2 style="margin:6px 0">GAME OVER</h2>
          <div style="margin:6px 0">ƒêi·ªÉm: <strong id="final-score">0</strong></div>
          <div style="margin:6px 0">ƒêi·ªÉm cao nh·∫•t: <strong id="final-high">0</strong></div>
          <div style="margin-top:8px"><button id="btn-restart"
              style="padding:8px 14px;border-radius:10px;border:none;background:#8bc34a;cursor:pointer">CH∆†I
              L·∫†I</button></div>
        </div>
      </div>

      <div id="top-ui">
        <div class="score-card">
          <div id="lives">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
          <div style="opacity:.6">|</div>
          <div style="text-align:right">
            <div id="score">0</div>
            <div class="score-small">HS: <span id="high-score">0</span></div>
          </div>
        </div>
        <div id="controls-right">
          <button id="btn-pause"
            style="width:46px;height:46px;border-radius:999px;border:none;background:#ff7043;color:#fff;cursor:pointer">
            <span id="pause-icon">‚è∏</span>
          </button>
        </div>
      </div>

      <div id="control-buttons">
        <button id="btn-left" class="control-btn">‚óÄ</button>
        <button id="btn-right" class="control-btn">‚ñ∂</button>
      </div>

      <div id="basket"><img id="basket-img" src="./player.png" alt="player" class="basket-normal-float"></div>

    </div>
  </div>

  <audio id="bgm" loop preload="auto">
    <source src="./music.mp3">
  </audio>
  <audio id="sfx-eat" preload="auto">
    <source src="./eat_fruit.mp3">
  </audio>
  <audio id="sfx-ouch" preload="auto">
    <source src="./ouch_huhu.mp3">
  </audio>

  <script>
    (function () {
      const BASE_W = 950, BASE_H = 600;
      const CONTAINER = document.getElementById('game-container');
      const WRAP = document.getElementById('game-wrap');
      const BASKET = document.getElementById('basket');
      const BASKET_IMG = document.getElementById('basket-img');
      const SCORE_EL = document.getElementById('score');
      const LIVES_EL = document.getElementById('lives');
      const HIGHSCORE_EL = document.getElementById('high-score');
      const START_SCREEN = document.getElementById('start-screen');
      const PAUSE_SCREEN = document.getElementById('pause-screen');
      const GAME_OVER = document.getElementById('game-over');
      const ROTATE = document.getElementById('rotate-overlay');
      const BTN_START = document.getElementById('btn-start');
      const BTN_RESTART = document.getElementById('btn-restart');
      const BTN_PAUSE = document.getElementById('btn-pause');
      const BTN_RESUME = document.getElementById('btn-resume');
      const BTN_RESTART2 = document.getElementById('btn-restart-2');
      const MUSIC_TOGGLE = document.getElementById('music-toggle');
      const VOL_SLIDER = document.getElementById('vol-slider');
      const BTN_DIFF = document.getElementById('btn-diff');
      const DIFF_LABEL = document.getElementById('diff-label');
      const BTN_LEFT = document.getElementById('btn-left');
      const BTN_RIGHT = document.getElementById('btn-right');

      const PAUSE_ICON = document.getElementById('pause-icon');

      const BGM = document.getElementById('bgm');
      const SFX_EAT = document.getElementById('sfx-eat');
      const SFX_OUCH = document.getElementById('sfx-ouch');

      const ITEMS = [{ type: 'good', emoji: 'üçé', score: 10, speed: 3 }, { type: 'good', emoji: 'üçå', score: 15, speed: 4 }, { type: 'good', emoji: 'üçì', score: 20, speed: 5 }, { type: 'bad', emoji: 'üóø', score: -5, speed: 6 }, { type: 'bomb', emoji: 'üí£', score: 0, speed: 6 }];

      const pool = []; const active = new Set();

      const state = { running: false, paused: false, score: 0, lives: 3, high: 0, scale: 1, mouseX: BASE_W / 2, basketW: 110, basketH: 110, speedMul: 1, spawnRate: 1200, difficulty: 1 };

      let rafId = null, spawnTimer = null, birdTimer = null, cloudTimer = null, airplaneTimer = null, lastTime = 0; // TH√äM cloudTimer, airplaneTimer
      let musicPlaying = false;

      function createItem() { let el = pool.pop(); if (!el) { el = document.createElement('div'); el.className = 'item' } el.style.top = '-100px'; el.style.left = '0px'; el.dataset.active = '0'; CONTAINER.appendChild(el); return el }
      function releaseItem(el) { if (!el) return; el.remove(); el.dataset.active = '0'; pool.push(el); active.delete(el) }

      function spawnItem() { if (!state.running || state.paused) return; const data = ITEMS[Math.floor(Math.random() * ITEMS.length)]; const el = createItem(); el.textContent = data.emoji; el.dataset.type = data.type; el.dataset.speed = (data.speed * state.speedMul).toString(); el.dataset.score = data.score; el.style.left = Math.max(0, Math.random() * (BASE_W - 60)) + 'px'; el.dataset.y = -60; el.dataset.active = '1'; el.dataset.tainted = '0'; el.classList.remove('tainted'); const mark = el.querySelector('.bomb-mark'); if (mark) mark.remove(); active.add(el); }

      // C·∫¨P NH·∫¨T: Th√™m nhi·ªÅu lo·∫°i chim h∆°n v√† animation ng·∫´u nhi√™n
      function spawnBird() {
        if (!state.running || state.paused) return;
        const b = document.createElement('div');
        const birdEmojis = ['üê¶', 'üïäÔ∏è', 'ü¶Ö', 'ü¶â', 'ü¶Ü'];
        b.textContent = birdEmojis[Math.floor(Math.random() * birdEmojis.length)];
        b.className = 'bird';
        b.style.top = (30 + Math.random() * 150) + 'px';
        b.style.left = '-120px';

        const duration = 8 + Math.random() * 4; // Bay t·ª´ 8-12 gi√¢y
        const delay = Math.random() * 2; // Delay ng·∫´u nhi√™n 
        b.style.animation = `fly-across ${duration}s linear ${delay}s infinite`;

        CONTAINER.appendChild(b);
        setTimeout(() => b.remove(), (duration + delay) * 1000 * 1.1);
      }

      // M·ªöI: T·∫°o m√¢y
      function spawnCloud() {
        if (!state.running || state.paused) return;
        const c = document.createElement('div');
        const sizes = ['small', 'medium', 'large'];
        const randomSize = sizes[Math.floor(Math.random() * sizes.length)];
        c.className = `cloud ${randomSize}`;
        c.style.top = (20 + Math.random() * 200) + 'px';
        c.style.left = '-200px';

        const baseDuration = parseFloat(c.style.animationDuration) || 60;
        c.style.animationDuration = (baseDuration + (Math.random() * 20 - 10)) + 's';
        c.style.animationName = 'move-cloud'; // ƒê·∫£m b·∫£o d√πng animation move-cloud

        CONTAINER.appendChild(c);
        setTimeout(() => c.remove(), (parseFloat(c.style.animationDuration) * 1000) * 1.2);
      }

      // M·ªöI: T·∫°o m√°y bay
      function spawnAirplane() {
        if (!state.running || state.paused) return;
        const a = document.createElement('div');
        const airplanes = ['‚úàÔ∏è', 'üõ©Ô∏è'];
        a.textContent = airplanes[Math.floor(Math.random() * airplanes.length)];
        a.className = 'airplane';
        a.style.top = (20 + Math.random() * 80) + 'px';
        a.style.left = '-300px';

        const duration = 15 + Math.random() * 10;
        a.style.animationDuration = duration + 's';
        a.style.animationName = 'fly-airplane'; // ƒê·∫£m b·∫£o d√πng animation fly-airplane

        CONTAINER.appendChild(a);
        setTimeout(() => a.remove(), duration * 1000 * 1.2);
      }

      function markTaintedAround(bomb) { const bx = parseFloat(bomb.style.left); const by = parseFloat(bomb.dataset.y); for (const it of Array.from(active)) { if (it === bomb) continue; if (it.dataset.active !== '1') continue; const ix = parseFloat(it.style.left); const iy = parseFloat(it.dataset.y); const dx = Math.abs(ix - bx); const dy = Math.abs(iy - by); if (dx < 70 && dy < 70 && it.dataset.tainted === '0') { it.dataset.tainted = '1'; it.classList.add('tainted'); const m = document.createElement('div'); m.className = 'bomb-mark'; m.textContent = 'üí•'; it.appendChild(m); } } }

      function isCollide(item) { const x = parseFloat(item.style.left); const y = parseFloat(item.dataset.y); const itemW = 56, itemH = 56; const basketLeft = state.mouseX - (state.basketW / 2); const basketTop = BASE_H - state.basketH - 10; const a = { left: x, right: x + itemW, top: y, bottom: y + itemH }; const b = { left: basketLeft, right: basketLeft + state.basketW, top: basketTop, bottom: basketTop + state.basketH }; const padY = 18, padX = 6; return !(a.bottom < b.top + padY || a.top > b.bottom || a.right < b.left + padX || a.left > b.right - padX); }

      function playSparkle(x, y) {
        const s = document.createElement('img'); s.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80"><g fill="none" stroke="gold" stroke-width="4"><path d="M40 6 L44 30 L68 30 L48 44 L54 68 L40 52 L26 68 L32 44 L12 30 L36 30 Z" fill="yellow"/></g></svg>';
        s.className = 'sparkle'; s.style.left = (x - 20) + 'px'; s.style.top = (y - 20) + 'px'; CONTAINER.appendChild(s);
        requestAnimationFrame(() => s.classList.add('show'));
        setTimeout(() => s.remove(), 600);
        if (SFX_EAT) { SFX_EAT.currentTime = 0; SFX_EAT.play().catch(() => { }); }
      }

      function playBoom(x, y, isBomb = false) {
        const boom = document.createElement('div'); boom.className = 'boom'; boom.style.left = (x - 80) + 'px'; boom.style.top = (y - 80) + 'px'; CONTAINER.appendChild(boom);
        setTimeout(() => boom.remove(), 650);

        WRAP.classList.add('game-shake');
        setTimeout(() => WRAP.classList.remove('game-shake'), 800);

        BASKET_IMG.src = './player-hurt.png';
        BASKET_IMG.classList.add('bomb-hit');
        BASKET_IMG.classList.remove('basket-normal-float');
        setTimeout(() => {
          BASKET_IMG.src = './player.png';
          BASKET_IMG.classList.remove('bomb-hit');
          BASKET_IMG.classList.add('basket-normal-float');
        }, isBomb ? 600 : 400);

        if (SFX_OUCH) { SFX_OUCH.currentTime = 0; SFX_OUCH.play().catch(() => { }); }
        navigator.vibrate && navigator.vibrate(120);
      }

      function handleCatch(item) {
        const type = item.dataset.type;
        const scoreVal = parseInt(item.dataset.score) || 0;
        const tainted = item.dataset.tainted === '1';
        releaseItem(item);

        if (type === 'good' && !tainted) {
          state.score += scoreVal;
          const left = parseFloat(item.style.left);
          const top = parseFloat(item.dataset.y);

          BASKET_IMG.src = './player-happy.png';
          playSparkle(left + 28, top + 28);
          BASKET_IMG.classList.add('basket-glow', 'basket-bounce');
          BASKET_IMG.classList.remove('basket-normal-float');

          setTimeout(() => {
            BASKET_IMG.classList.remove('basket-glow', 'basket-bounce');
            BASKET_IMG.src = './player.png';
            BASKET_IMG.classList.add('basket-normal-float');
          }, 350);
        } else {
          state.lives--;
          const isBomb = (type === 'bomb');
          playBoom(state.mouseX, BASE_H - 80, isBomb);
        }
        updateUI();
        checkEnd();
      }

      function handleMiss(item) { const type = item.dataset.type; const tainted = item.dataset.tainted === '1'; releaseItem(item); if (type === 'good' && !tainted) { state.lives--; updateUI(); checkEnd(); } }

      function checkEnd() { if (state.lives <= 0) endGame(); }

      function updateUI() { SCORE_EL.textContent = state.score; LIVES_EL.textContent = '‚ù§Ô∏è'.repeat(Math.max(0, state.lives)); HIGHSCORE_EL.textContent = state.high; document.getElementById('pause-score').textContent = state.score; }

      function loop(now) {
        if (!state.running || state.paused) { return; }

        const dt = (now - lastTime) / (1000 / 60) || 1;
        lastTime = now;

        const half = state.basketW / 2; let bx = state.mouseX - half; if (bx < 0) bx = 0; if (bx > BASE_W - state.basketW) bx = BASE_W - state.basketW; BASKET.style.left = bx + 'px';
        for (const item of Array.from(active)) {
          if (item.dataset.active !== '1') continue; let y = parseFloat(item.dataset.y); const speed = parseFloat(item.dataset.speed) || 3; y += speed * dt; item.dataset.y = y; item.style.top = y + 'px';
          if (item.dataset.type === 'bomb') { markTaintedAround(item); }
          if (isCollide(item)) { handleCatch(item); continue; }
          if (y > BASE_H) { handleMiss(item); continue; }
        }
        rafId = requestAnimationFrame(loop);
      }

      // C·∫¨P NH·∫¨T: Th√™m logic timer cho m√¢y v√† m√°y bay
      function startSpawning() {
        clearInterval(spawnTimer); spawnTimer = setInterval(spawnItem, state.spawnRate);
        clearInterval(birdTimer); birdTimer = setInterval(spawnBird, 5000 + Math.random() * 3000);

        clearInterval(cloudTimer); cloudTimer = setInterval(spawnCloud, 8000 + Math.random() * 5000);
        clearInterval(airplaneTimer); airplaneTimer = setInterval(spawnAirplane, 20000 + Math.random() * 10000);
      }

      // C·∫¨P NH·∫¨T: D·ª´ng v√† x√≥a c√°c ph·∫ßn t·ª≠ background
      function stopSpawning() {
        clearInterval(spawnTimer);
        clearInterval(birdTimer);
        clearInterval(cloudTimer);
        clearInterval(airplaneTimer);

        // X√≥a t·∫•t c·∫£ c√°c v·∫≠t ph·∫©m r∆°i v√† c√°c y·∫øu t·ªë background
        document.querySelectorAll('.item, .bird, .cloud, .airplane').forEach(el => el.remove());
      }

      function startGame() {
        state.running = true; state.paused = false; state.score = 0; state.lives = 3; state.mouseX = BASE_W / 2;
        loadHigh(); updateUI(); START_SCREEN.classList.add('hidden'); GAME_OVER.classList.add('hidden'); PAUSE_SCREEN.classList.add('hidden');

        stopSpawning(); // G·ªçi stopSpawning tr∆∞·ªõc ƒë·ªÉ x√≥a t·∫•t c·∫£ c√°c elements c≈©

        lastTime = performance.now();
        rafId = requestAnimationFrame(loop);
        startSpawning();
      }

      function pauseGame() {
        if (!state.running) return;
        state.paused = true;
        PAUSE_SCREEN.classList.remove('hidden');
        stopSpawning();
        if (rafId) cancelAnimationFrame(rafId);
        if (PAUSE_ICON) PAUSE_ICON.textContent = '‚ñ∂';
        if (!BGM.paused) BGM.pause();
      }

      function resumeGame() {
        if (!state.running) return;
        state.paused = false;
        PAUSE_SCREEN.classList.add('hidden');

        lastTime = performance.now();

        rafId = requestAnimationFrame(loop);
        if (PAUSE_ICON) PAUSE_ICON.textContent = '‚è∏';
        startSpawning();
        if (musicPlaying) BGM.play().catch(() => { });
      }

      function endGame() {
        state.running = false;
        stopSpawning();
        if (rafId) cancelAnimationFrame(rafId);
        saveHigh();
        document.getElementById('final-score').textContent = state.score;
        document.getElementById('final-high').textContent = state.high;
        GAME_OVER.classList.remove('hidden');
        if (!BGM.paused) BGM.pause();
      }

      function setDifficulty(level) { state.difficulty = level; switch (level) { case 1: state.speedMul = 1; state.spawnRate = 1200; DIFF_LABEL.textContent = 'D·ªÖ'; DIFF_LABEL.style.color = '#2e7d32'; break; case 2: state.speedMul = 1.5; state.spawnRate = 900; DIFF_LABEL.textContent = 'Trung b√¨nh'; DIFF_LABEL.style.color = '#ef6c00'; break; case 3: state.speedMul = 2.2; state.spawnRate = 600; DIFF_LABEL.textContent = 'Kh√≥'; DIFF_LABEL.style.color = '#c62828'; break } stopSpawning(); if (state.running && !state.paused) startSpawning(); }

      function computeScale() {
        const ww = window.innerWidth, hh = window.innerHeight;

        if (ww < BASE_W && hh > ww) {
          WRAP.style.visibility = 'hidden';
          ROTATE.classList.add('show');
        } else {
          WRAP.style.visibility = 'visible';
          ROTATE.classList.remove('show');
        }

        const sx = ww / BASE_W, sy = hh / BASE_H;
        const scale = Math.min(sx, sy, 1.2);
        state.scale = scale;
        WRAP.style.setProperty('--scale', scale);

        CTRL_WRAP = document.getElementById('control-buttons');
        CTRL_WRAP.style.display = (ww <= 940 ? 'flex' : 'none');
      }

      function onPointer(e) {
        if (!state.running || state.paused) return;
        const rect = CONTAINER.getBoundingClientRect();
        const scale = state.scale;
        const clientX = (e.clientX !== undefined) ? e.clientX : (e.touches && e.touches[0] && e.touches[0].clientX);
        if (clientX == null) return;
        const gameX = (clientX - rect.left) / scale;
        state.mouseX = Math.max(0, Math.min(BASE_W, gameX));
      }

      let moveInterval = null;
      function startMove(dir) { if (moveInterval) clearInterval(moveInterval); moveInterval = setInterval(() => { state.mouseX += dir * 14; }, 16); }
      function stopMove() { if (moveInterval) clearInterval(moveInterval); moveInterval = null; }

      function loadHigh() { state.high = parseInt(localStorage.getItem('fruitCatchHigh') || '0'); HIGHSCORE_EL.textContent = state.high; document.getElementById('start-high').textContent = state.high; }
      function saveHigh() { if (state.score > state.high) { state.high = state.score; localStorage.setItem('fruitCatchHigh', state.high); HIGHSCORE_EL.textContent = state.high; } }

      // bindings
      CONTAINER.addEventListener('pointermove', onPointer);
      CONTAINER.addEventListener('pointerdown', (e) => {
        if (e.pointerType === 'touch') {
          e.preventDefault();
        }
        onPointer(e);
      });
      CONTAINER.addEventListener('touchmove', (e) => { e.preventDefault(); onPointer(e.touches ? e.touches[0] : e); }, { passive: false });

      BTN_START.addEventListener('click', () => { startGame(); if (musicPlaying) BGM.play().catch(() => { }); });
      BTN_RESTART && BTN_RESTART.addEventListener('click', () => startGame());
      BTN_RESTART2 && BTN_RESTART2.addEventListener('click', () => startGame());

      BTN_PAUSE.addEventListener('click', () => {
        if (!state.running) return;
        if (state.paused) {
          resumeGame();
        } else {
          pauseGame();
        }
      });
      BTN_RESUME && BTN_RESUME.addEventListener('click', () => resumeGame());

      BTN_LEFT.addEventListener('pointerdown', (e) => { e.preventDefault(); startMove(-1); }); BTN_LEFT.addEventListener('pointerup', stopMove); BTN_LEFT.addEventListener('pointercancel', stopMove); BTN_LEFT.addEventListener('pointerleave', stopMove);
      BTN_RIGHT.addEventListener('pointerdown', (e) => { e.preventDefault(); startMove(1); }); BTN_RIGHT.addEventListener('pointerup', stopMove); BTN_RIGHT.addEventListener('pointercancel', stopMove); BTN_RIGHT.addEventListener('pointerleave', stopMove);

      window.addEventListener('keydown', (e) => { if (e.key === 'ArrowLeft') startMove(-1); if (e.key === 'ArrowRight') startMove(1); if (e.key === ' ') { if (!state.running) startGame(); else { if (state.paused) resumeGame(); else pauseGame(); } } });
      window.addEventListener('keyup', (e) => { if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') stopMove(); });

      // music controls
      MUSIC_TOGGLE.addEventListener('click', () => { if (!musicPlaying) { BGM.volume = parseFloat(VOL_SLIDER.value); BGM.play().catch(() => { }); musicPlaying = true; MUSIC_TOGGLE.textContent = 'üîä'; } else { BGM.pause(); musicPlaying = false; MUSIC_TOGGLE.textContent = 'üîà'; } });
      VOL_SLIDER.addEventListener('input', () => { BGM.volume = parseFloat(VOL_SLIDER.value); });

      BTN_DIFF.addEventListener('click', () => { let next = state.difficulty + 1; if (next > 3) next = 1; setDifficulty(next); });

      // LOGIC KH·ªûI T·∫†O
      function initialize() {
        computeScale();
        loadHigh();
        setDifficulty(1);

        musicPlaying = true;
        BGM.volume = parseFloat(VOL_SLIDER.value);
        BGM.play().catch(error => { });
        if (MUSIC_TOGGLE) MUSIC_TOGGLE.textContent = 'üîä';
      }


      // init
      initialize();
      window.addEventListener('resize', computeScale);
      window.addEventListener('orientationchange', () => setTimeout(computeScale, 260));

      window.__game = { start: startGame, pause: pauseGame, resume: resumeGame, setDiff: setDifficulty };
    })();
  </script>
</body>

</html>